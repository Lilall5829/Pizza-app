# 🚀 Supabase 线上部署指南

## 步骤 1: 创建线上项目

### 1.1 访问 Supabase

- 打开 [https://supabase.com](https://supabase.com)
- 注册或登录账户

### 1.2 创建新项目

1. 点击 "New Project"
2. 填写项目信息：
   ```
   Project Name: food-ordering
   Database Password: [设置强密码，记住它]
   Region: Southeast Asia (Singapore) 或离你最近的
   Pricing Plan: Free (开始时选择免费)
   ```
3. 点击 "Create new project"
4. 等待 1-2 分钟项目创建完成

## 步骤 2: 获取配置信息

项目创建完成后：

1. 在项目仪表板，点击左侧 "Settings" → "API"
2. 复制以下信息：
   - **Project URL**: `https://你的项目ID.supabase.co`
   - **anon public**: `eyJ开头的长字符串`

## 步骤 3: 部署数据库结构

### 3.1 通过 Web 界面部署（推荐）

1. 在 Supabase 项目中，点击左侧 "SQL Editor"
2. 点击 "New query"
3. 复制粘贴数据库迁移脚本（见下方）
4. 点击 "Run" 执行

### 3.2 使用 CLI 部署（可选）

```bash
# 1. 登录 Supabase CLI
npx supabase login

# 2. 连接到你的项目
npx supabase link --project-ref YOUR_PROJECT_ID

# 3. 推送数据库结构
npx supabase db push
```

## 步骤 4: 数据库迁移脚本

在 SQL Editor 中运行以下脚本：

```sql
-- 创建产品表
CREATE TABLE IF NOT EXISTS products (
    id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    name text NOT NULL,
    image text,
    price real NOT NULL
);

-- 创建用户档案表
CREATE TABLE IF NOT EXISTS profiles (
    id uuid REFERENCES auth.users(id) ON DELETE CASCADE PRIMARY KEY,
    updated_at timestamp with time zone,
    username text,
    full_name text,
    avatar_url text,
    website text,
    "group" text DEFAULT 'USER' NOT NULL,
    CONSTRAINT username_length CHECK (char_length(username) >= 3)
);

-- 创建订单表
CREATE TABLE IF NOT EXISTS orders (
    id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    status text DEFAULT 'New' NOT NULL,
    total double precision DEFAULT 0 NOT NULL,
    user_id uuid REFERENCES profiles(id) ON UPDATE CASCADE ON DELETE CASCADE
);

-- 创建订单项目表
CREATE TABLE IF NOT EXISTS order_items (
    id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    created_at timestamp with time zone DEFAULT now() NOT NULL,
    product_id bigint REFERENCES products(id) ON UPDATE CASCADE ON DELETE CASCADE NOT NULL,
    size text DEFAULT 'M' NOT NULL,
    quantity integer DEFAULT 1 NOT NULL,
    order_id bigint REFERENCES orders(id) ON UPDATE CASCADE ON DELETE CASCADE NOT NULL
);

-- 创建用户注册触发器函数
CREATE OR REPLACE FUNCTION handle_new_user()
RETURNS trigger AS $$
BEGIN
  INSERT INTO public.profiles (id, full_name, avatar_url)
  VALUES (new.id, new.raw_user_meta_data->>'full_name', new.raw_user_meta_data->>'avatar_url');
  RETURN new;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- 创建触发器
DROP TRIGGER IF EXISTS on_auth_user_created ON auth.users;
CREATE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW EXECUTE PROCEDURE handle_new_user();

-- 设置行级安全策略 (RLS)
ALTER TABLE products ENABLE ROW LEVEL SECURITY;
ALTER TABLE profiles ENABLE ROW LEVEL SECURITY;
ALTER TABLE orders ENABLE ROW LEVEL SECURITY;
ALTER TABLE order_items ENABLE ROW LEVEL SECURITY;

-- 产品表策略：认证用户可以进行所有操作
CREATE POLICY "Allow authenticated users ALL operations" ON products
  FOR ALL TO authenticated USING (true) WITH CHECK (true);

-- 用户档案策略
CREATE POLICY "Public profiles are viewable by everyone" ON profiles
  FOR SELECT USING (true);

CREATE POLICY "Users can insert their own profile" ON profiles
  FOR INSERT WITH CHECK (auth.uid() = id);

CREATE POLICY "Users can update own profile" ON profiles
  FOR UPDATE USING (auth.uid() = id);

-- 订单策略：认证用户可以进行所有操作
CREATE POLICY "All operations to authenticated users" ON orders
  FOR ALL TO authenticated USING (true);

-- 订单项目策略：认证用户可以进行所有操作
CREATE POLICY "All operations to authenticated users" ON order_items
  FOR ALL TO authenticated USING (true);

-- 启用实时订阅
ALTER PUBLICATION supabase_realtime ADD TABLE orders;
```

## 步骤 5: 更新环境配置

将你的 `.env` 文件更新为：

```env
# Supabase 线上配置
EXPO_PUBLIC_SUPABASE_URL=https://你的项目ID.supabase.co
EXPO_PUBLIC_SUPABASE_ANON=你的anon_public密钥

# Stripe 配置 (保持不变)
EXPO_PUBLIC_STRIPE_PUBLISHABLE_KEY=pk_test_51P7JPaP8kqU6cZlPtVSZYqBltWgb07wvR04cwN9pcLo3Co3Sxr5jzJv25fzfGUJKtVj9QN02RW44EUHiqU0QeToY004hJbPkvw
STRIPE_SECRET_KEY=sk_test_51P7JPaP8kqU6cZlPpJA8xie9QGmP8EipfCC4eZh4KoBoyTxE7LYPMiEeVFR3vyQ41VRPAVV0yXmlx9XiqCYeuRs3008RKr9UUE
```

## 步骤 6: 添加示例数据（可选）

在 SQL Editor 中运行：

```sql
-- 添加示例产品数据
INSERT INTO products (name, image, price) VALUES
('Margherita Pizza', 'https://example.com/margherita.jpg', 12.99),
('Pepperoni Pizza', 'https://example.com/pepperoni.jpg', 15.99),
('Hawaiian Pizza', 'https://example.com/hawaiian.jpg', 16.99),
('Veggie Supreme', 'https://example.com/veggie.jpg', 14.99);
```

## 步骤 7: 测试连接

更新配置后，重启应用：

```bash
npm start
```

检查：

1. 应用能否正常启动
2. 是否能看到产品列表
3. 用户注册/登录是否工作

## 🔒 安全注意事项

1. **数据库密码**: 妥善保管你设置的数据库密码
2. **API 密钥**: 不要将密钥提交到公共代码仓库
3. **RLS 策略**: 根据需要调整行级安全策略

## 🎯 完成标志

部署成功的标志：

- ✅ Supabase 项目创建成功
- ✅ 数据库表创建完成
- ✅ 应用能连接到线上数据库
- ✅ 用户认证功能正常
- ✅ 产品数据能正常加载
