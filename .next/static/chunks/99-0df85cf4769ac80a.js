"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[99],{555:function(e,t,r){r.d(t,{IA:function(){return u},Tn:function(){return c}});var n=r(5526),o=r(3896),s=r(6593),a=r(9827),i=r(1770);let u=()=>{let{session:e}=(0,o.a)(),t=null==e?void 0:e.user.id;return(0,s.a)({queryKey:["orders",{userId:t}],queryFn:async()=>{if(!t)return null;let{data:e,error:r}=await n.O.from("orders").select("*").eq("user_id",t).order("created_at",{ascending:!1});if(r)throw Error(r.message);return e}})},c=()=>{let e=(0,a.NL)(),{session:t}=(0,o.a)(),r=null==t?void 0:t.user.id;return(0,i.D)({async mutationFn(e){let{error:t,data:o}=await n.O.from("orders").insert({...e,user_id:r}).select().single();if(t)throw Error(t.message);return o},async onSuccess(){await e.invalidateQueries({queryKey:["orders"]})}})}},5526:function(e,t,r){r.d(t,{O:function(){return n}});let n=(0,r(6082).eI)("https://qvaydsqqgpufbzjudzod.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InF2YXlkc3FxZ3B1ZmJ6anVkem9kIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDg0OTA1NTUsImV4cCI6MjA2NDA2NjU1NX0.SEB2IZrZCvAXsijuaRDeLLA6B0DYrBHdlzKVGr5L2v0")},3896:function(e,t,r){r.d(t,{Z:function(){return u},a:function(){return c}});var n=r(7437),o=r(5526),s=r(2265),a=r(9064);let i=(0,s.createContext)({session:null,profile:null,loading:!0,isAdmin:!1});function u(e){var t;let{children:r}=e,[u,c]=(0,s.useState)(null),[l,d]=(0,s.useState)(null),[m,f]=(0,s.useState)(!0),y=(0,s.useRef)(null),p=async e=>{try{let{data:t,error:r}=await o.O.from("profiles").select("*").eq("id",e).single();if(r)return console.error("Error fetching profile:",r),null;return t}catch(e){return console.error("Error fetching profile:",e),null}};return(0,s.useEffect)(()=>{(async()=>{let{data:{session:e}}=await o.O.auth.getSession();if(console.log("Initial session:",e),c(e),y.current=e,e){let t=await p(e.user.id);d(t),console.log("Profile loaded:",t)}else d(null);f(!1)})();let{data:{subscription:e}}=o.O.auth.onAuthStateChange(async(e,t)=>{var r;console.log("Auth state changed:",e,null==t?void 0:null===(r=t.user)||void 0===r?void 0:r.email);let n=y.current;if(c(t),y.current=t,t){let r=await p(t.user.id);d(r),console.log("Profile refreshed:",r),n||"SIGNED_IN"!==e||a.ZP.success("Successfully signed in!")}else d(null);f(!1)});return()=>e.unsubscribe()},[]),console.log("Current auth state:",{userEmail:null==u?void 0:null===(t=u.user)||void 0===t?void 0:t.email,userRole:null==l?void 0:l.group,isAdmin:(null==l?void 0:l.group)==="ADMIN"}),(0,n.jsx)(i.Provider,{value:{session:u,loading:m,profile:l,isAdmin:(null==l?void 0:l.group)==="ADMIN"},children:r})}let c=()=>(0,s.useContext)(i)},9099:function(e,t,r){r.d(t,{Z:function(){return S},j:function(){return v}});var n=r(7437),o=r(5526),s=r(9827),a=r(1770);let i=()=>((0,s.NL)(),(0,a.D)({async mutationFn(e){let{error:t,data:r}=await o.O.from("order_items").insert(e).select();if(t)throw Error(t.message);return r}}));var u=r(555),c=r(2360);let l="pk_test_51P7JPaP8kqU6cZlPtVSZYqBltWgb07wvR04cwN9pcLo3Co3Sxr5jzJv25fzfGUJKtVj9QN02RW44EUHiqU0QeToY004hJbPkvw";l.startsWith("pk_test_")||console.warn("⚠️ Warning: Not using Stripe test key! Current key:",l.substring(0,20)+"...");let d=(0,c.J)(l),m=async e=>{console.log("\uD83D\uDD04 Attempting to fetch payment sheet params for amount:",e/100,"USD");try{let{data:{session:t},error:r}=await o.O.auth.getSession();if(r)throw console.error("❌ Session error:",r),Error("Authentication error: "+r.message);if(!t)throw Error("User not authenticated. Please sign in first.");console.log("✅ User authenticated:",t.user.email),console.log("\uD83D\uDCE1 Calling Supabase Function: payment-sheet");let{data:n,error:s}=await o.O.functions.invoke("payment-sheet",{body:{amount:e}});if(s){if(console.error("❌ Supabase Function error:",s),s.message.includes("Failed to fetch")||s.message.includes("CORS"))throw Error("\uD83C\uDF10 CORS Error: Supabase Function not deployed or CORS not configured.\nSolutions:\n1. Deploy the function: supabase functions deploy payment-sheet\n2. Check function logs in Supabase Dashboard\n3. Verify function is running at: https://qvaydsqqgpufbzjudzod.supabase.co/functions/v1/payment-sheet");if(s.message.includes("unauthorized")||s.message.includes("401"))throw Error("Authentication failed. Please sign out and sign back in.");throw Error("Supabase Function error: "+s.message)}if(!n)throw Error("No data returned from payment function");return console.log("✅ Payment sheet params fetched successfully"),n}catch(e){if(console.error("\uD83D\uDCA5 Error in fetchPaymentSheetParams:",e),e instanceof Error&&e.message.includes("Failed to fetch"))throw console.log("\uD83D\uDD27 Falling back to simulated payment due to network error"),Error("\uD83C\uDF10 Network Error: Cannot connect to Supabase Function.\nThis might be because:\n• Function not deployed\n• CORS configuration issue\n• Network connectivity problem\n\nTry switching to simulated payment mode for testing.");throw e}},f=async e=>{try{if(!await d)throw Error("Stripe failed to load");console.log("\uD83D\uDCB3 Processing TEST payment for amount:",e/100,"USD"),console.log("\uD83D\uDE80 Using REAL Stripe API in test mode");try{let t=await m(e);return console.log("✅ Payment Intent created:",t.paymentIntent),console.log("\uD83D\uDCCA Check your Stripe Dashboard for this test transaction!"),{success:!0,paymentMethod:"stripe_test_api",paymentIntentId:t.paymentIntent}}catch(e){if(console.error("Stripe payment error:",e),e instanceof Error&&e.message.includes("CORS"))return console.log("\uD83D\uDD04 Falling back to simulated payment due to CORS issue"),await new Promise(e=>setTimeout(e,1e3)),{success:!0,paymentMethod:"simulated_fallback",note:"Used simulated payment due to Supabase Function issue"};throw e}}catch(e){return console.error("Payment processing error:",e),{success:!1,error:e instanceof Error?e.message:"Payment failed"}}};var y=r(9376),p=r(2265),g=r(9064);let h=(0,p.createContext)({items:[],addItem:()=>{},updateQuantity:()=>{},total:0,checkout:async()=>{}});var S=e=>{let{children:t}=e,[r,o]=(0,p.useState)([]),[s,a]=(0,p.useState)(!1),c=(0,y.useRouter)(),{mutate:l}=(0,u.Tn)(),{mutate:d}=i();(0,p.useEffect)(()=>{o(function(){try{let e=localStorage.getItem("food-ordering-cart");return e?JSON.parse(e):[]}catch(e){return console.error("Failed to load cart from storage:",e),[]}}()),a(!0)},[]),(0,p.useEffect)(()=>{s&&function(e){try{localStorage.setItem("food-ordering-cart",JSON.stringify(e))}catch(e){console.error("Failed to save cart to storage:",e)}}(r)},[r,s]);let m=Number(r.reduce((e,t)=>e+=t.product.price*t.quantity,0).toFixed(2)),S=()=>{o([])},v=async e=>{if(0===r.length){g.ZP.error("Your cart is empty");return}g.ZP.loading("Processing your payment...");try{let t=await f(Math.floor(100*m));if(!t.success){g.ZP.dismiss(),g.ZP.error(t.error||"Payment failed");return}let r={total:m};e&&(r.customer_name=e.customerName,r.delivery_phone=e.phone,r.delivery_address=e.address,r.delivery_city=e.city,r.delivery_province=e.province,r.delivery_postal_code=e.postalCode,r.delivery_country=e.country,r.delivery_instructions=e.instructions||null),l(r,{onSuccess:D,onError:e=>{g.ZP.dismiss(),g.ZP.error("Failed to create order"),console.error("Order creation failed:",e)}})}catch(e){g.ZP.dismiss(),g.ZP.error("Payment processing failed"),console.error("Payment error:",e)}},D=e=>{d(r.map(t=>({order_id:e.id,product_id:t.product_id,quantity:t.quantity,size:t.size})),{onSuccess(){g.ZP.dismiss(),g.ZP.success("Order placed successfully!"),S(),c.push("/orders/".concat(e.id))},onError:e=>{g.ZP.dismiss(),g.ZP.error("Failed to save order items"),console.error("Order items creation failed:",e)}})};return(0,n.jsx)(h.Provider,{value:{items:r,addItem:function(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,s=r.find(r=>r.product.id===e.id&&r.size===t);s?o(r.map(e=>e.id===s.id?{...e,quantity:e.quantity+n}:e)):o([{id:"cart-"+Date.now().toString(36)+Math.random().toString(36).substr(2),product:e,product_id:e.id,size:t,quantity:n},...r]),1===n?g.ZP.success("".concat(e.name," added to cart")):g.ZP.success("".concat(n," ").concat(e.name," added to cart"))},updateQuantity:(e,t)=>{o(r.map(r=>r.id!=e?r:{...r,quantity:r.quantity+t}).filter(e=>e.quantity>0))},total:m,checkout:v},children:t})};let v=()=>(0,p.useContext)(h)}}]);